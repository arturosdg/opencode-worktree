#!/usr/bin/env node

import fs from 'node:fs';
import path from 'node:path';
import os from 'node:os';
import { spawn } from 'node:child_process';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const pkg = JSON.parse(
  fs.readFileSync(new URL('../package.json', import.meta.url), 'utf8'),
);

const detectPlatformAndArch = () => {
  let platform;
  switch (os.platform()) {
    case 'darwin':
      platform = 'darwin';
      break;
    case 'linux':
      platform = 'linux';
      break;
    case 'win32':
      platform = 'windows';
      break;
    default:
      platform = os.platform();
      break;
  }

  let arch;
  switch (os.arch()) {
    case 'x64':
      arch = 'x64';
      break;
    case 'arm64':
      arch = 'arm64';
      break;
    default:
      arch = os.arch();
      break;
  }

  return { platform, arch };
};

const resolveBinaryPath = () => {
  const { platform } = detectPlatformAndArch();
  const binaryName = platform === 'windows' ? 'opencode-worktree.exe' : 'opencode-worktree-bin';
  const binaryPath = path.join(__dirname, '..', 'bin', binaryName);

  if (!fs.existsSync(binaryPath)) {
    throw new Error(
      `Binary not found at ${binaryPath}. Run npm install -g ${pkg.name} again to re-download.`,
    );
  }

  return binaryPath;
};

const run = () => {
  try {
    const binaryPath = resolveBinaryPath();
    const args = process.argv.slice(2);
    const child = spawn(binaryPath, args, { stdio: 'inherit' });

    child.on('exit', (code) => {
      process.exit(code ?? 0);
    });

    child.on('error', (error) => {
      console.error('Failed to start opencode-worktree binary.');
      console.error(error);
      process.exit(1);
    });
  } catch (error) {
    console.error('Failed to locate opencode-worktree binary.');
    console.error(error instanceof Error ? error.message : String(error));
    process.exit(1);
  }
};

run();
